<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<!--Converted with LaTeX2HTML 2008 (1.71)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>Copias de Seguridad con rsync</TITLE>
<META NAME="description" CONTENT="Copias de Seguridad con rsync">
<META NAME="keywords" CONTENT="perlexamples">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="Generator" CONTENT="LaTeX2HTML v2008">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="mystyle.css">

<LINK REL="previous" HREF="node661.html">
<LINK REL="up" HREF="node660.html">
<LINK REL="next" HREF="node663.html">
</HEAD>

<BODY >

<DIV CLASS="navigation"><!--Navigation Panel-->
<A NAME="tex2html14661"
  HREF="node663.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html14655"
  HREF="node660.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html14651"
  HREF="node661.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html14657"
  HREF="node823.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html14659"
  HREF="node826.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html29"
  HREF="http://tinyurl.com/lpp1415"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="LPP moodle"></A><A NAME="tex2html30"
  HREF="https://campusvirtual.ull.es/1415/course/view.php?id=5678"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="SYTW moodle"></A><A NAME="tex2html31"
  HREF="perlexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="pdf"></A><A NAME="tex2html32"
  HREF="https://dl.dropbox.com/u/14539152/LPP/LPPbook/index.html"><IMG
  WIDTH="60" ALIGN="BOTTOM" BORDER="0"
 SRC="lupa.gif"
 ALT="ruby gems"></A><A NAME="tex2html33"
  HREF="http://www.ruby-doc.org/"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="perlonion.jpeg"
 ALT="perldoc"></A><A NAME="tex2html34"
  HREF="http://www.github.com"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="google-code-project-hosting.jpeg"
 ALT="github"></A><A NAME="tex2html35"
  HREF="http://rubylearning.com/blog/"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="blogs"></A><A NAME="tex2html36"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html37"
  HREF="http://www.ull.es/view/centros/etsii/Inicio/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html38"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html39"
  HREF="https://plus.google.com/u/0/communities/115470806071217401678"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-lpp-1314"></A><A NAME="tex2html40"
  HREF="https://plus.google.com/u/0/communities/109091480492072495700"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-stw-1314"></A>
<BR>
<B> Siguiente:</B> <A NAME="tex2html14662"
  HREF="node663.html">Git</A>
<B> Subir:</B> <A NAME="tex2html14656"
  HREF="node660.html">Copia Segura de un</A>
<B> Anterior:</B> <A NAME="tex2html14652"
  HREF="node661.html">Transferencia de ficheros por</A>
 &nbsp; <B>  <A NAME="tex2html14658"
  HREF="node823.html">&#205;ndice General</A></B> 
 &nbsp; <B>  <A NAME="tex2html14660"
  HREF="node826.html">&#205;ndice de Materias</A></B> 
<BR>
<BR></DIV>
<!--End of Navigation Panel-->
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><STRONG>Subsecciones</STRONG></A>

<UL CLASS="ChildLinks">
<LI><UL>
<LI><A NAME="tex2html14663"
  HREF="node662.html#SECTION065122010000000000000">El Algoritmo</A>
<LI><A NAME="tex2html14664"
  HREF="node662.html#SECTION065122020000000000000">Mode de Uso</A>
<LI><A NAME="tex2html14665"
  HREF="node662.html#SECTION065122030000000000000">Los módulos <TT>File::Rsync</TT> y <TT>File::RsyncP</TT></A>
<LI><A NAME="tex2html14666"
  HREF="node662.html#SECTION065122040000000000000">Backups con <TT>rsync</TT> en un Medio Externo</A>
<LI><A NAME="tex2html14667"
  HREF="node662.html#SECTION065122050000000000000">El fichero <TT>/etc/fstab</TT></A>
<LI><A NAME="tex2html14668"
  HREF="node662.html#SECTION065122060000000000000">El Programa de Copia</A>
<LI><A NAME="tex2html14669"
  HREF="node662.html#SECTION065122070000000000000">Configuraciones SSH en <TT>.ssh/config</TT> y <TT>/etc/sshd_config</TT></A>
<LI><A NAME="tex2html14670"
  HREF="node662.html#SECTION065122080000000000000">El fichero de <TT>cron</TT></A>
<LI><A NAME="tex2html14671"
  HREF="node662.html#SECTION065122090000000000000">Comprobación de la Copia</A>
</UL></UL>
<!--End of Table of Child-Links-->
<HR>

<H2><A NAME="SECTION065122000000000000000">
Copias de Seguridad con <TT>rsync</TT></A>
</H2>

<P>

<H4><A NAME="SECTION065122010000000000000">
El Algoritmo</A>
</H4>
  

<P>
El programa  <TT>rsync</TT>  permite la sincronización de 
ficheros y directorios
entre dos máquinas minimizando el tamaño de la trasmisión
mediante el cálculo de las diferencias entre las versiones
existentes en las dos localizaciones implicadas.

<P>
<A NAME="tex2html1570"
  HREF="http://manpages.debian.net/cgi-bin/man.cgi?query=rsync"><TT>rsync</TT></A>
opera e la siguiente forma (véase <A NAME="tex2html1571"
  HREF="http://en.wikipedia.org/wiki/Rsync">Rsync</A>:

<P>

<OL>
<LI>El usuario especifica las máquinas de origen y destino asi como los ficheros a 
actualizar

<P>
</LI>
<LI>La máquina de destino descompone el fichero objetivo en pequeños 
bloques de tamaño fijo y genera checksums para cada bloque

<P>
</LI>
<LI>La máquina destino transmite sus checksums a la máquina fuente

<P>
</LI>
<LI>La máquina fuente busca el fichero y encuentra los bloques para los cuales
los checksum casan con los suyos

<P>
</LI>
<LI>La máquina fuente genera un conjunto de instrucciones que la máquina destino
puede usar para actualizar el fichero

<P>
</LI>
<LI>La máquina fuente envía a la máquina de destino las instrucciones
asi como los datos de aquellas partes que no casan al destino

<P>
</LI>
<LI>La máquina de destino utiliza las instrucciones y los nuevos datos para
actualizar sus ficheros 
</LI>
</OL>

<P>

<H4><A NAME="SECTION065122020000000000000">
Mode de Uso</A>
</H4>
  

<P>
Normalmente se usara como en el ejemplo vía SSH:
<PRE>
rsync -aue ssh /home/user/public_html/ user@orion:/home/user/public_html/directory/
</PRE>

<P>
La opción <code>-a</code> es equivalente a <code>-rlptgoD</code>.
El significado de cada una de estas opciones es:

<UL>
<LI><code>-r, --recursive</code> Desciende recursivamente en los subdirectorios
</LI>
<LI><code>-l, --links</code> Copia enlaces
</LI>
<LI><code>-p, --perms</code> Preserva permisos
</LI>
<LI><code>-t, --times</code> Preserva los tiempos
</LI>
<LI><code>-g, --group</code> Preserva los grupos
</LI>
<LI><code>-o, --owner</code> Preserva el propietarios (solo si es el root)
</LI>
<LI><code>-D, --devices</code> Preserva los dispositivos (sólo si es el root)
</LI>
</UL>
La opción <code>-u, --update</code> 
permite saltarse aquellos ficheros que son mas recientes
en el receptor.

<P>
La opción <code>-e</code> permite especificar que <code>ssh</code> será utilizada.

<P>

<H4><A NAME="SECTION065122030000000000000">
Los módulos <TT>File::Rsync</TT> y <TT>File::RsyncP</TT></A>
</H4>
  

<P>
El módulo <A NAME="tex2html1572"
  HREF="http://search.cpan.org/perldoc?File::Rsync"><TT>File::Rsync</TT></A>
ofrece una API de acceso a <code>rsync</code>:
<PRE>
pp2@nereida:~/LCALL$ perl -MFile::Rsync -wde 0
main::(-e:1):   0
  DB&lt;1&gt; $obj = File::Rsync-&gt;new( { archive =&gt; 1, rsh =&gt; '/usr/bin/ssh -l loginname', \
                                  'rsync-path' =&gt; '/usr/bin/rsync' } )
  DB&lt;2&gt; $obj-&gt;exec( { src =&gt; '/home/pp2/public_html/', dest =&gt; 'machine:/home/loginname/public_html/pp2/' } )
  DB&lt;3&gt; q
pp2@nereida:~/LCALL$ ssh loginname@machine 'ls -ltr | tail -3'
drwxr-xr-x  38 loginname loginname        4096 2007-03-21 07:26 pp2
drwxr-xr-x  60 loginname loginname        4096 2007-03-21 08:08 pl
drwxr-xr-x   7 loginname loginname        4096 2007-03-21 12:20 public_html
pp2@nereida:~/LCALL$ ssh loginname@machine date
mié mar 21 12:26:37 WET 2007
</PRE>
Otro módulo es <A NAME="tex2html1573"
  HREF="http://search.cpan.org/perldoc?File::RsyncP"><TT>File::RsyncP</TT></A>, enteramente escrito en Perl.

<P>

<H4><A NAME="SECTION065122040000000000000">
Backups con <TT>rsync</TT> en un Medio Externo</A>
</H4>
  

<P>
Veamos como hacer una copia diaria de una máquina remota (<code>someserver</code>)
a un disco USB externo en otra máquina <code>mylaptop</code>.

<P>

<H4><A NAME="SECTION065122050000000000000">
El fichero <TT>/etc/fstab</TT></A>
</H4>
  

<P>
La última línea del fichero <code>/etc/fstab</code> muestra la información de montaje:
<PRE>
root@mylaptop:~# cat /etc/fstab
# /etc/fstab: static file system information.
#
# &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;
proc            /proc           proc    defaults        0       0
# /dev/sda1
UUID=45797091-2b2f-45b2-95c1-2bfaaea20253 /               ext3    relatime,errors=remount-ro 0       1
# /dev/sda5
UUID=83fce336-1f21-4690-9544-dc7dd988ea71 none            swap    sw              0       0
/dev/scd0       /media/cdrom0   udf,iso9660 user,noauto,exec,utf8 0       0
/dev/fd0        /media/floppy0  auto    rw,user,noauto,exec,utf8 0       0
/dev/sdb1       /media/PORTABLE ext3    rw,nosuid,nodev,uhelper=hal,data=ordered
</PRE>

<P>

<H4><A NAME="SECTION065122060000000000000">
El Programa de Copia</A>
</H4>
  

<P>
<PRE>
casiano@mylaptop:~/bin$ cat -n someserverbackuptoportabledisk.pl
 1  #!/usr/bin/perl
 2  use strict;
 3  use Log::Log4perl qw{:easy};
 4
 5  my $ismounted = `mount 2&gt;&amp;1`;
 6
 7  # log file is in /home/casiano/backup.log
 8  Log::Log4perl::init('/home/casiano/bin/logconfig');
 9  my $log = Log::Log4perl-&gt;get_logger();
10
11  if ($ismounted =~ m{/media/PORTABLE}) {
12
13    my $agent = `keychain --eval --agents ssh 2&gt;&amp;1`;
14    $log-&gt;logdie("Error executing keychain") if $?;
15
16    $agent =~ m{SSH_AUTH_SOCK=([^;]+);};
17    $ENV{SSH_AUTH_SOCK} = $1;
18
19    $log-&gt;info("Executing ssh someserverbackup");
20    my $backupinfo = `rsync -ae ssh someserverbackup:/root/ /media/PORTABLE/someserver/root/ 2&gt;&amp;1`;
21    $log-&gt;info($backupinfo);
22
23    $backupinfo = `rsync -ae ssh someserverbackup:/home/ /media/PORTABLE/someserver/home/ 2&gt;&amp;1`;
24    $log-&gt;info($backupinfo);
25
26    exit($?);
27  }
28  $log-&gt;logdie("/media/PORTABLE not mounted\n");
</PRE>

<P>
La clave está protegida con una passphrase. Previamente se ha cargado un agente y se le ha dado
la clave <code>/home/casiano/.ssh/someserverbackupidentity</code> que es la utilizada en las conexiones
que efectúan las dos llamadas a <code>rsync</code>.

<P>

<H4><A NAME="SECTION065122070000000000000">
Configuraciones SSH en <TT>.ssh/config</TT> y <TT>/etc/sshd_config</TT></A>
</H4>
  

<P>
Deberá existir una entrada como esta en el fichero <code>~/.ssh/config</code>:

<P>
<PRE>
Host someserverbackup
HostName someserver
user root
IdentityFile /home/casiano/.ssh/someserverbackupidentity
BatchMode yes
</PRE>
la clave <code>/home/casiano/.ssh/someserverbackupidentity</code>
ha sido publicada en <code>someserver</code>.

<P>
La máquina debe permitir el acceso al administrador vía SSH:

<P>
<PRE>
root@mylaptop:/etc/ssh# grep -i permitroot sshd_config
PermitRootLogin yes
</PRE>

<P>

<H4><A NAME="SECTION065122080000000000000">
El fichero de <TT>cron</TT></A>
</H4>
  

<P>
<PRE>
casiano@mylaptop:~$ crontab -e
</PRE>
El fichero fué generado con <code>kcron</code>:

<P>
<PRE>
   # backup de someserver a las 14 y a las 0 horas en disco portable
   0 3,21 * * *    /home/casiano/bin/someserverbackuptoportabledisk.pl
   # This file was written by KCron. Copyright (c) 1999, Gary Meyer
   # Although KCron supports most crontab formats, use care when editing.
   # Note: Lines beginning with "#\" indicates a disabled task.
</PRE>

<P>

<H4><A NAME="SECTION065122090000000000000">
Comprobación de la Copia</A>
</H4>
  

<P>
Es necesario comprobar que las copias se están haciendo correctamente.
En mi agenda pongo una tarea que consiste en comprobar la copia.
En mi home en cada una de máquinas hay un fichero
<code>AUTOMATICBACKUPCHECKOUT</code> que contiene la fecha. Si 
la copia de seguridad de dicho fichero contiene 
la fecha del día anterior, es señal de que el proceso 
copió el fichero.
En el momento de comprobar la copia actualizo 
manualmente la fecha almacenada en dicho fichero.
Este proceso es facilitado por el siguiente 
guión:

<P>
<PRE>
casiano@mylaptop:~/bin$ cat -n checkbackup
 1  #!/bin/bash
 2  for f in /backup/someserver/home/casiano/AUTOMATICBACKUPCHECKOUT \
             /media/PORTABLE/someserver/home/casiano/AUTOMATICBACKUPCHECKOUT;  do
 3    echo "Observe the date of $f:";
 4    ls -l $f;
 5
 6    echo "Contents of $f";
 7    echo "***************************************************************";
 8    cat $f;
 9    echo "***************************************************************";
10  done
11
12  echo "Now we are going to edit AUTOMATICBACKUPCHECKOUT and the backup log file,"
13  echo "press any key to continue and fill the file with today's date"
14
15  # Wait for key to be pressed
16  read -n 1
17  # Edit both remote and local files
18  vi -p scp://someserver/AUTOMATICBACKUPCHECKOUT /home/casiano/mylaptopbackup.log
</PRE>

<P>
En el caso de errores puede ser útil revisar el fichero de logs:
<PRE>
casiano@mylaptop:~$ cat backup.log
2009/05/06 15:53:42 INFO someserverbackuptoportabledisk.pl-19-main::: Executing ssh someserverbackup
2009/05/06 15:57:12 INFO someserverbackuptoportabledisk.pl-19-main::: Executing ssh someserverbackup
</PRE>

<P>

<DIV CLASS="navigation"><HR>
<!--Navigation Panel-->
<A NAME="tex2html14661"
  HREF="node663.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html14655"
  HREF="node660.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html14651"
  HREF="node661.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html14657"
  HREF="node823.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html14659"
  HREF="node826.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html29"
  HREF="http://tinyurl.com/lpp1415"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="LPP moodle"></A><A NAME="tex2html30"
  HREF="https://campusvirtual.ull.es/1415/course/view.php?id=5678"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="SYTW moodle"></A><A NAME="tex2html31"
  HREF="perlexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="pdf"></A><A NAME="tex2html32"
  HREF="https://dl.dropbox.com/u/14539152/LPP/LPPbook/index.html"><IMG
  WIDTH="60" ALIGN="BOTTOM" BORDER="0"
 SRC="lupa.gif"
 ALT="ruby gems"></A><A NAME="tex2html33"
  HREF="http://www.ruby-doc.org/"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="perlonion.jpeg"
 ALT="perldoc"></A><A NAME="tex2html34"
  HREF="http://www.github.com"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="google-code-project-hosting.jpeg"
 ALT="github"></A><A NAME="tex2html35"
  HREF="http://rubylearning.com/blog/"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="blogs"></A><A NAME="tex2html36"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html37"
  HREF="http://www.ull.es/view/centros/etsii/Inicio/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html38"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html39"
  HREF="https://plus.google.com/u/0/communities/115470806071217401678"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-lpp-1314"></A><A NAME="tex2html40"
  HREF="https://plus.google.com/u/0/communities/109091480492072495700"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-stw-1314"></A>
<BR>
<B> Siguiente:</B> <A NAME="tex2html14662"
  HREF="node663.html">Git</A>
<B> Subir:</B> <A NAME="tex2html14656"
  HREF="node660.html">Copia Segura de un</A>
<B> Anterior:</B> <A NAME="tex2html14652"
  HREF="node661.html">Transferencia de ficheros por</A>
 &nbsp; <B>  <A NAME="tex2html14658"
  HREF="node823.html">&#205;ndice General</A></B> 
 &nbsp; <B>  <A NAME="tex2html14660"
  HREF="node826.html">&#205;ndice de Materias</A></B> </DIV>
<!--End of Navigation Panel-->
<ADDRESS>
Casiano Rodriguez León
2014-11-20
</ADDRESS>
</BODY>
</HTML>
