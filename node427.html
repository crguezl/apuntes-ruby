<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<!--Converted with LaTeX2HTML 2008 (1.71)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>A simple demonstration of streaming Redis pub/sub data</TITLE>
<META NAME="description" CONTENT="A simple demonstration of streaming Redis pub/sub data">
<META NAME="keywords" CONTENT="perlexamples">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="Generator" CONTENT="LaTeX2HTML v2008">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="mystyle.css">

<LINK REL="next" HREF="node428.html">
<LINK REL="previous" HREF="node426.html">
<LINK REL="up" HREF="node422.html">
<LINK REL="next" HREF="node428.html">
</HEAD>

<BODY >

<DIV CLASS="navigation"><!--Navigation Panel-->
<A NAME="tex2html10087"
  HREF="node428.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html10081"
  HREF="node422.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html10075"
  HREF="node426.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html10083"
  HREF="node735.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html10085"
  HREF="node738.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html29"
  HREF="http://nereida.deioc.ull.es/~lpp/index.html"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="logoLPP.png"
 ALT="LPP"></A><A NAME="tex2html30"
  HREF="http://campusvirtual.ull.es/1314/course/view.php?id=1102"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="LPP moodle"></A><A NAME="tex2html31"
  HREF="http://campusvirtual.ull.es/1314/course/view.php?id=1091"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="SYTW moodle"></A><A NAME="tex2html32"
  HREF="perlexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="pdf"></A><A NAME="tex2html33"
  HREF="https://dl.dropbox.com/u/14539152/LPP/LPPbook/index.html"><IMG
  WIDTH="60" ALIGN="BOTTOM" BORDER="0"
 SRC="lupa.gif"
 ALT="ruby gems"></A><A NAME="tex2html34"
  HREF="http://www.ruby-doc.org/"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="perlonion.jpeg"
 ALT="perldoc"></A><A NAME="tex2html35"
  HREF="http://www.github.com"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="google-code-project-hosting.jpeg"
 ALT="github"></A><A NAME="tex2html36"
  HREF="http://rubylearning.com/blog/"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="blogs"></A><A NAME="tex2html37"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html38"
  HREF="http://www.ull.es/view/centros/etsii/Inicio/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html39"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html40"
  HREF="https://plus.google.com/u/0/communities/115470806071217401678"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-lpp-1314"></A><A NAME="tex2html41"
  HREF="https://plus.google.com/u/0/communities/109091480492072495700"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-stw-1314"></A>
<BR>
<B> Siguiente:</B> <A NAME="tex2html10088"
  HREF="node428.html">Comet</A>
<B> Subir:</B> <A NAME="tex2html10082"
  HREF="node422.html">Streaming</A>
<B> Anterior:</B> <A NAME="tex2html10076"
  HREF="node426.html">Enlaces Relacionados</A>
 &nbsp; <B>  <A NAME="tex2html10084"
  HREF="node735.html">&#205;ndice General</A></B> 
 &nbsp; <B>  <A NAME="tex2html10086"
  HREF="node738.html">&#205;ndice de Materias</A></B> 
<BR>
<BR></DIV>
<!--End of Navigation Panel-->

<H1><A NAME="SECTION03850000000000000000">
A simple demonstration of streaming Redis pub/sub data</A>
</H1>
Véase:

<OL>
<LI><A NAME="tex2html925"
  HREF="https://github.com/gorsuch/sinatra-streaming-example">A simple demonstration of streaming Redis pub/sub data over HTTP via Sinatra's streaming capabilities.</A>
</LI>
<LI><A NAME="tex2html926"
  HREF="https://github.com/crguezl/sinatra-streaming-example">A simple demonstration of streaming Redis pub/sub data over HTTP via Sinatra's streaming capabilities.</A>
forked version crguezl
</LI>
<LI>Véa el capítulo <I>Redis y Sinatra</I> <A HREF="node458.html#chapter:redisysinatra">36</A>
</LI>
<LI><A NAME="tex2html927"
  HREF="https://github.com/redis/redis-rb">redis</A>
gem en GitHub
</LI>
<LI><A NAME="tex2html928"
  HREF="http://rubydoc.info/gems/redis/3.0.6/frames">redis</A>
documentación de la gema
</LI>
<LI><A NAME="tex2html929"
  HREF="http://redis.io/topics/pubsub">Redis Pub/Sub</A>
</LI>
<LI><A NAME="tex2html930"
  HREF="http://rubydoc.info/gems/redis/3.0.6/Redis/Subscription">Redis::Subscription</A>:
</LI>
<LI><A NAME="tex2html931"
  HREF="https://addons.heroku.com/redistogo">Heroku addon Redis To Go</A>
</LI>
</OL>

<P>

<H4><A NAME="SECTION03850010000000000000">
web.rb</A>
</H4>
  

<PRE>
[~/sinatra/sinatra-streaming/sinatra-streaming-example(master)]$ cat web.rb
require 'redis'
require 'sinatra'

configure do
  redis_url = ENV["REDISTOGO_URL"] || "redis://localhost:6379"
  uri = URI.parse(redis_url)
  set :redis, Redis.new(:host =&gt; uri.host, :port =&gt; uri.port, :password =&gt; uri.password)
end

get '/' do
  "&lt;pre&gt;curl -v https://sinatra-streaming-example.herokuapp.com/stream&lt;/pre&gt;"
end

get '/stream' do
  puts "connection made"

  stream do |out|
    settings.redis.subscribe 'time' do |on|
      on.message do |channel, message|
        out &lt;&lt; "#{message}\n"
      end
    end
  end
end
</PRE>
<A NAME="tex2html932"
  HREF="http://redis.com">Redis</A> is a key-value store; it supports lists, hashes, sets, and ordered sets.

<P>
El código 
<PRE>
  redis_url = ENV["REDISTOGO_URL"] || "redis://localhost:6379"
</PRE>
decide si estamos en Heroku o no. Si estamos en Heroku deberemos haber instalado
el <A NAME="tex2html933"
  HREF="https://addons.heroku.com/redistogo">Heroku addon Redis To Go</A>.

<P>
La llamada:
<PRE>
  set :redis, Redis.new(:host =&gt; uri.host, :port =&gt; uri.port, :password =&gt; uri.password)
</PRE>
conecta con el servidor Redis.

<P>
The Redis class exports methods that are named identical to the
commands they execute. The arguments these methods accept are often
identical to the arguments specified on the Redis website.

<P>
In Redis,
<code>SUBSCRIBE</code>, <code>UNSUBSCRIBE</code> and <code>PUBLISH</code> implement 
the <A NAME="tex2html934"
  HREF="http://en.wikipedia.org/wiki/Publish/subscribe">Publish/Subscribe</A>
messaging paradigm where 

<OL>
<LI>In the <A NAME="17552"></A><SPAN  CLASS="textbf">Publish/Subscribe</SPAN> pattern, senders (publishers) are not programmed to send their messages to
specific receivers (subscribers). 
</LI>
<LI>Rather, published messages are
characterized into channels, without knowledge of what (if any)
subscribers there may be. 
</LI>
<LI>Subscribers express interest in one or
more channels, and only receive messages that are of interest,
without knowledge of what (if any) publishers there are. 
</LI>
<LI>This
decoupling of publishers and subscribers can allow for greater
scalability and a more dynamic network topology.
</LI>
</OL>
For instance in order to subscribe to channels <code>foo</code> and <code>bar</code> the
client issues a <code>SUBSCRIBE</code> providing the names of the channels:
<PRE>
SUBSCRIBE foo bar
</PRE>

<P>
Messages sent by other clients to these channels will be pushed by
Redis to all the subscribed clients.

<P>
A client subscribed to one or more channels should not issue commands,
although it can subscribe and unsubscribe to and from other channels.

<P>
The reply of the <code>SUBSCRIBE</code> and <code>UNSUBSCRIBE</code> operations are sent in
the form of messages, so that the client can just read a coherent
stream of messages where the first element indicates the type of
message.

<P>
El objeto <code>on</code> pasado al bloque está en la clase
<A NAME="tex2html935"
  HREF="http://rubydoc.info/gems/redis/3.0.6/Redis/Subscription">Redis::Subscription</A>:
<PRE>
    settings.redis.subscribe 'time' do |on|
      on.message do |channel, message|
        out &lt;&lt; "#{message}\n"
      end
</PRE>
el objeto <code>on</code> dispone del método <code>message</code> que establece una callback
que será ejecutada cada vez que se produzca un mensaje.

<P>

<H4><A NAME="SECTION03850020000000000000">
worker.rb</A>
</H4>
  

<PRE>
[~/sinatra/sinatra-streaming/sinatra-streaming-example(master)]$ cat worker.rb 
require 'uri'
require 'redis'

redis_url = ENV["REDISTOGO_URL"] || "redis://localhost:6379"
uri = URI.parse(redis_url)
r = Redis.new(:host =&gt; uri.host, :port =&gt; uri.port, :password =&gt; uri.password)

while true do
  puts "publishing..."
  r.publish "time", Time.now.utc
  sleep 1  
end
</PRE>

<P>

<H4><A NAME="SECTION03850030000000000000">
Procfile</A>
</H4>
  

<PRE>
[~/sinatra/sinatra-streaming/sinatra-streaming-example(master)]$ cat Procfile 
web: bundle exec ruby web.rb -p $PORT
worker: bundle exec ruby worker.rb
</PRE>
The <code>web</code> process type, describes to Heroku how to start the web application server.

<P>
<A NAME="tex2html936"
  HREF="http://www.neilmiddleton.com/the-procfile-is-your-friend/">An interesting thing to mention here is that Heroku</A>
only auto-launches
the web process in your Procfile when deploying, whereas <code>foreman</code>
launches everything. 

<P>

<H4><A NAME="SECTION03850040000000000000">
Gemfile</A>
</H4>
  

<PRE>
[~/sinatra/sinatra-streaming/sinatra-streaming-example(master)]$ cat Gemfile
source 'https://rubygems.org'

gem 'foreman'
gem 'redis'
gem 'sinatra'
gem 'thin'
</PRE>

<P>

<H4><A NAME="SECTION03850050000000000000">
Ejecución: Arranca el Servidor Redis</A>
</H4>
  

<P>
<PRE>
[~/sinatra/sinatra-streaming/sinatra-streaming-example(master)]$ redis-server 
[5604] 04 Dec 10:18:58.126 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
[5604] 04 Dec 10:18:58.129 * Max number of open files set to 10032
                _._                                                  
           _.-``__ ''-._                                             
      _.-``    `.  `_.  ''-._           Redis 2.6.14 (00000000/0) 64 bit
  .-`` .-```.  ```\/    _.,_ ''-._                                   
 (    '      ,       .-`  | `,    )     Running in stand alone mode
 |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379
 |    `-._   `._    /     _.-'    |     PID: 5604
  `-._    `-._  `-./  _.-'    _.-'                                   
 |`-._`-._    `-.__.-'    _.-'_.-'|                                  
 |    `-._`-._        _.-'_.-'    |           http://redis.io        
  `-._    `-._`-.__.-'_.-'    _.-'                                   
 |`-._`-._    `-.__.-'    _.-'_.-'|                                  
 |    `-._`-._        _.-'_.-'    |                                  
  `-._    `-._`-.__.-'_.-'    _.-'                                   
      `-._    `-.__.-'    _.-'                                       
          `-._        _.-'                                           
              `-.__.-'                                               

[5604] 04 Dec 10:18:58.129 # Server started, Redis version 2.6.14
[5604] 04 Dec 10:18:58.129 * The server is now ready to accept connections on port 6379
</PRE>

<P>

<H4><A NAME="SECTION03850060000000000000">
Ejecución 2: Arranca la aplicación Sinatra y el Worker</A>
</H4>
  

Obsérvese como <code>bundle exec foreman start</code> arranca tanto a <code>worker</code> como 
a <code>web</code>:

<P>
<PRE>
[~/sinatra/sinatra-streaming/sinatra-streaming-example(master)]$ bundle exec foreman start
10:19:04 web.1     | started with pid 5606
10:19:04 worker.1  | started with pid 5607
10:19:05 worker.1  | publishing...
10:19:06 web.1     | == Sinatra/1.3.0 has taken the stage on 5000 for development with backup from Thin
10:19:06 web.1     | &gt;&gt; Thin web server (v1.2.11 codename Bat-Shit Crazy)
10:19:06 web.1     | &gt;&gt; Maximum connections set to 1024
10:19:06 web.1     | &gt;&gt; Listening on 0.0.0.0:5000, CTRL+C to stop
10:19:06 worker.1  | publishing...
10:19:07 worker.1  | publishing...
10:19:08 worker.1  | publishing...
..................................
10:19:37 worker.1  | publishing...
10:19:38 web.1     | connection made
10:19:39 worker.1  | publishing...
..................................
</PRE>

<P>

<H4><A NAME="SECTION03850070000000000000">
Ejecución 3: Arranca un Cliente</A>
</H4>
  

<PRE>
[~/sinatra/sinatra-streaming/sinatra-streaming-example(master)]$ curl -v http://localhost:5000/stream
* Adding handle: conn: 0x7fc71280aa00
* Adding handle: send: 0
* Adding handle: recv: 0
* Curl_addHandleToPipeline: length: 1
* - Conn 0 (0x7fc71280aa00) send_pipe: 1, recv_pipe: 0
* About to connect() to localhost port 5000 (#0)
*   Trying 127.0.0.1...
* Connected to localhost (127.0.0.1) port 5000 (#0)
&gt; GET /stream HTTP/1.1
&gt; User-Agent: curl/7.30.0
&gt; Host: localhost:5000
&gt; Accept: */*
&gt; 
&lt; HTTP/1.1 200 OK
&lt; X-Frame-Options: sameorigin
&lt; X-XSS-Protection: 1; mode=block
&lt; Content-Type: text/html;charset=utf-8
&lt; Connection: close
* Server thin 1.2.11 codename Bat-Shit Crazy is not blacklisted
&lt; Server: thin 1.2.11 codename Bat-Shit Crazy
&lt; 
2013-12-04 13:24:13 UTC
2013-12-04 13:24:14 UTC
2013-12-04 13:24:15 UTC
2013-12-04 13:24:16 UTC
2013-12-04 13:24:17 UTC
.......................
</PRE>

<P>
<BR><HR>
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><STRONG>Subsecciones</STRONG></A>

<UL CLASS="ChildLinks">
<LI><UL>
<LI><UL>
<LI><A NAME="tex2html10089"
  HREF="node427.html#SECTION03850010000000000000">web.rb</A>
<LI><A NAME="tex2html10090"
  HREF="node427.html#SECTION03850020000000000000">worker.rb</A>
<LI><A NAME="tex2html10091"
  HREF="node427.html#SECTION03850030000000000000">Procfile</A>
<LI><A NAME="tex2html10092"
  HREF="node427.html#SECTION03850040000000000000">Gemfile</A>
<LI><A NAME="tex2html10093"
  HREF="node427.html#SECTION03850050000000000000">Ejecución: Arranca el Servidor Redis</A>
<LI><A NAME="tex2html10094"
  HREF="node427.html#SECTION03850060000000000000">Ejecución 2: Arranca la aplicación Sinatra y el Worker</A>
<LI><A NAME="tex2html10095"
  HREF="node427.html#SECTION03850070000000000000">Ejecución 3: Arranca un Cliente</A>
</UL></UL></UL>
<!--End of Table of Child-Links-->

<DIV CLASS="navigation"><HR>
<!--Navigation Panel-->
<A NAME="tex2html10087"
  HREF="node428.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html10081"
  HREF="node422.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html10075"
  HREF="node426.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html10083"
  HREF="node735.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html10085"
  HREF="node738.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html29"
  HREF="http://nereida.deioc.ull.es/~lpp/index.html"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="logoLPP.png"
 ALT="LPP"></A><A NAME="tex2html30"
  HREF="http://campusvirtual.ull.es/1314/course/view.php?id=1102"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="LPP moodle"></A><A NAME="tex2html31"
  HREF="http://campusvirtual.ull.es/1314/course/view.php?id=1091"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="SYTW moodle"></A><A NAME="tex2html32"
  HREF="perlexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="pdf"></A><A NAME="tex2html33"
  HREF="https://dl.dropbox.com/u/14539152/LPP/LPPbook/index.html"><IMG
  WIDTH="60" ALIGN="BOTTOM" BORDER="0"
 SRC="lupa.gif"
 ALT="ruby gems"></A><A NAME="tex2html34"
  HREF="http://www.ruby-doc.org/"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="perlonion.jpeg"
 ALT="perldoc"></A><A NAME="tex2html35"
  HREF="http://www.github.com"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="google-code-project-hosting.jpeg"
 ALT="github"></A><A NAME="tex2html36"
  HREF="http://rubylearning.com/blog/"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="blogs"></A><A NAME="tex2html37"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html38"
  HREF="http://www.ull.es/view/centros/etsii/Inicio/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html39"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html40"
  HREF="https://plus.google.com/u/0/communities/115470806071217401678"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-lpp-1314"></A><A NAME="tex2html41"
  HREF="https://plus.google.com/u/0/communities/109091480492072495700"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-stw-1314"></A>
<BR>
<B> Siguiente:</B> <A NAME="tex2html10088"
  HREF="node428.html">Comet</A>
<B> Subir:</B> <A NAME="tex2html10082"
  HREF="node422.html">Streaming</A>
<B> Anterior:</B> <A NAME="tex2html10076"
  HREF="node426.html">Enlaces Relacionados</A>
 &nbsp; <B>  <A NAME="tex2html10084"
  HREF="node735.html">&#205;ndice General</A></B> 
 &nbsp; <B>  <A NAME="tex2html10086"
  HREF="node738.html">&#205;ndice de Materias</A></B> </DIV>
<!--End of Navigation Panel-->
<ADDRESS>
Casiano Rodriguez León
2014-09-02
</ADDRESS>
</BODY>
</HTML>
