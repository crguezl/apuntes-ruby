<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<!--Converted with LaTeX2HTML 2008 (1.71)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>Sesiones y Cookies en Sinatra</TITLE>
<META NAME="description" CONTENT="Sesiones y Cookies en Sinatra">
<META NAME="keywords" CONTENT="perlexamples">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="Generator" CONTENT="LaTeX2HTML v2008">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="mystyle.css">

<LINK REL="next" HREF="node452.html">
<LINK REL="previous" HREF="node450.html">
<LINK REL="up" HREF="node433.html">
<LINK REL="next" HREF="node452.html">
</HEAD>

<BODY >

<DIV CLASS="navigation"><!--Navigation Panel-->
<A NAME="tex2html11172"
  HREF="node452.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html11166"
  HREF="node433.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html11160"
  HREF="node450.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html11168"
  HREF="node851.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html11170"
  HREF="node854.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html29"
  HREF="http://tinyurl.com/lpp1415"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="LPP moodle"></A><A NAME="tex2html30"
  HREF="https://campusvirtual.ull.es/1415/course/view.php?id=5678"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="SYTW moodle"></A><A NAME="tex2html31"
  HREF="perlexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="pdf"></A><A NAME="tex2html32"
  HREF="https://dl.dropbox.com/u/14539152/LPP/LPPbook/index.html"><IMG
  WIDTH="60" ALIGN="BOTTOM" BORDER="0"
 SRC="lupa.gif"
 ALT="ruby gems"></A><A NAME="tex2html33"
  HREF="http://www.ruby-doc.org/"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="perlonion.jpeg"
 ALT="perldoc"></A><A NAME="tex2html34"
  HREF="http://www.github.com"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="google-code-project-hosting.jpeg"
 ALT="github"></A><A NAME="tex2html35"
  HREF="http://rubylearning.com/blog/"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="blogs"></A><A NAME="tex2html36"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html37"
  HREF="http://www.ull.es/view/centros/etsii/Inicio/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html38"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html39"
  HREF="https://plus.google.com/u/0/communities/115470806071217401678"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-lpp-1314"></A><A NAME="tex2html40"
  HREF="https://plus.google.com/u/0/communities/109091480492072495700"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-stw-1314"></A>
<BR>
<B> Siguiente:</B> <A NAME="tex2html11173"
  HREF="node452.html">Downloads / Descargas /</A>
<B> Subir:</B> <A NAME="tex2html11167"
  HREF="node433.html">Fundamentos</A>
<B> Anterior:</B> <A NAME="tex2html11161"
  HREF="node450.html">Caching / Caches</A>
 &nbsp; <B>  <A NAME="tex2html11169"
  HREF="node851.html">&#205;ndice General</A></B> 
 &nbsp; <B>  <A NAME="tex2html11171"
  HREF="node854.html">&#205;ndice de Materias</A></B> 
<BR>
<BR></DIV>
<!--End of Navigation Panel-->

<H1><A NAME="SECTION033100000000000000000">
Sesiones y Cookies en Sinatra</A>
</H1>

<P>

<H4><A NAME="SECTION033100010000000000000">
Introducción</A>
</H4>
  

A session is used to keep state during requests. If activated, you
have one session hash per user session:

<P>
<PRE>
enable :sessions

get '/' do
  "value = " &lt;&lt; session[:value].inspect
end

get '/:value' do
  session[:value] = params[:value]
end
</PRE>

<OL>
<LI>Note that <code>enable :sessions</code> actually stores all data in a cookie
</LI>
<LI>This might not always be what you want (storing lots of data will increase your traffic, for instance)
</LI>
<LI>You can use any Rack session middleware: in order to do so, do not call <code>enable :sessions</code>, but instead pull in your middleware of choice as you would any other middleware:

<P>
<PRE>
use Rack::Session::Pool, :expire_after =&gt; 2592000

get '/' do
  "value = " &lt;&lt; session[:value].inspect
end

get '/:value' do
  session[:value] = params[:value]
end
</PRE>
</LI>
<LI>To improve security, the session data in the cookie is signed with a session secret
</LI>
<LI>A random secret is generated for you by Sinatra
</LI>
<LI>However, since this secret will change with every start of your application, you might want to set the secret yourself, so all your application instances share it:
<PRE>
set :session_secret, 'super secret'
</PRE>
If you want to configure it further, you may also store a hash with options in the sessions setting:
<PRE>
set :sessions, :domain =&gt; 'foo.com'
</PRE>
</LI>
<LI>Just use
<code>session.clear</code> to destroy the session.
<PRE>
get '/login' do
    session[:username] = params[:username]
    "logged in as #{session[:username]}"
  end

  get '/logout' do
    old_user = session[:username]
    session.clear
    "logged out #{old_user}"
  end
</PRE>
</LI>
</OL>

<P>

<H4><A NAME="SECTION033100020000000000000">
Cookies</A>
</H4>
  

<OL>
<LI>According to the Computer Science definition, a <A NAME="20257"></A><SPAN  CLASS="textbf">cookie</SPAN>, which is also known as an <A NAME="20259"></A><SPAN  CLASS="textbf">HTTP cookie</SPAN>, a <A NAME="20261"></A><SPAN  CLASS="textbf">tracking cookie</SPAN>, or a <A NAME="20263"></A><SPAN  CLASS="textbf">browser cookie</SPAN>, 

<FONT COLOR="#0000ff"> is a piece of text, no bigger than 4 kilobytes, which is stored on the user’s computer by a web server via a web browser</FONT>
</LI>
<LI>It is a key-value pair structure, which is designed to retain specific information such as 

<UL>
<LI>user preferences, 
</LI>
<LI>user authentication, 
</LI>
<LI>shopping carts, 
</LI>
<LI>demographics, 
</LI>
<LI>sessions, or 
</LI>
<LI>any other data used by a website
</LI>
</UL>
</LI>
<LI>This mechanism, which was developed by Netscape in the distant 1994, provides a way to receive information from a web server and to send it back from the web browser absolutely unchanged
</LI>
<LI>This system complements the stateless nature of the HTTP protocol as it provides enough memory to store pieces of information during HTTP transactions

<P>
</LI>
<LI>When you try to access a web site, your web browser connects to a web server and it sends a request for the respective page
</LI>
<LI>Then the web server replies by sending the requested content and it simultaneously stores a new cookie on your computer
</LI>
<LI>Every time the web browser requests web pages from the web server, it always sends the respective cookies back to the web server
</LI>
<LI>The process takes place as described, if the web browser supports cookies and the user allows their usage
</LI>
<LI>Only the web server can modify one or more of the cookie values
</LI>
<LI>Then it sends them to the web browser upon replying to a specific request

<P>
</LI>
<LI>According to the RFC2965 specification, cookies are case insensitive
</LI>
<LI>A set of defined properties is inherent to the cookie structure  Those properties include:
 an expiration date, a path and a domain
</LI>
<LI>The first attribute requires a date defined in <code>Wdy, DD-Mon-YYYY HH:MM:SS GMT</code> format
</LI>
<LI>The rest of the cookie characteristics require a <code>path</code> and/or a <code>domain</code> defined as a string
</LI>
<LI>Let’s take a look at this example:

<P>
<PRE>
Cookie: key0=value0; ...; keyX=valueX; expires=Wed, 23-Sep-2009 23:59:59 GMT; path=/; domain=.yoursite.com
</PRE>

<P>
</LI>
<LI>When the <code>expiration</code> date is defined, your cookie will be <A NAME="20267"></A><SPAN  CLASS="textbf">persistent</SPAN> as it will reoccur in different sessions until the set <code>expiration</code> date has been reached
</LI>
<LI>If the <code>expiration</code> date has not been defined in the cookie, it will occur until the end of your current session or when you close your web browser
</LI>
<LI>If the <code>path</code> and/or the <code>domain</code> attributes have been defined in your cookie, then the web server limits the scope of the cookie to that specific <code>domain</code>, <code>sub-domain</code> or <code>path</code>
</LI>
</OL>

<P>

<H4><A NAME="SECTION033100030000000000000">
Ejemplo con Sesiones</A>
</H4>
  

<PRE>
require 'rubygems'
require 'sinatra'
require 'haml'

enable :sessions

get '/' do
  session["user"] ||= nil
  haml :index
end

get '/introduction' do
  haml :introduction
end

post '/introduction' do
  session["user"] = params[:name]
  redirect '/'
end

get '/bye' do
  session["user"] = nil
  haml :bye
end
</PRE>

<P>

<H4><A NAME="SECTION033100040000000000000">
Ejemplo con Cookies</A>
</H4>
  

<OL>
<LI>The last example will demonstrate how to directly manage cookies through the 
<code>request</code> and <code>response</code> singletons provided by Sinatra
</LI>
<LI>You will see in the following example that the previously described process involving the use cookies is clearly implemented
</LI>
<LI>This technique is recommended when your application requires to use persistent and/or scoped cookies
</LI>
<LI>In this example, the application uses two persistent cookies, which expire at the same time, in order to store and manage different configuration data
</LI>
</OL>

<P>
<PRE>
require 'sinatra'
require 'haml'

get '/' do
  @@expiration_date = Time.now + (60 * 2) \
  unless request.cookies.key?('some_options') &amp;&amp; request.cookies.key?('other_options')
  haml :index
end

get '/some_options' do
  @some_cookie = request.cookies["some_options"]
  haml :some_options
end

post '/some_options' do  
  response.set_cookie('some_options', :value =&gt; cookie_values(params), :expires =&gt; @@expiration_date)
  redirect '/'
end

get '/other_options' do
  @other_cookie = request.cookies["other_options"]
  haml :other_options
end

post '/other_options' do
  response.set_cookie('other_options', :value =&gt; cookie_values(params),:expires =&gt; @@expiration_date)
  redirect '/'
end

helpers do
  def cookie_values(parameters)
    values = {}
    parameters.each do |key, value|
      case key
      when 'options'
        values[value] = true
      else
        values[key] = true
      end
    end
    values
  end
end
</PRE>

<P>

<H4><A NAME="SECTION033100050000000000000">
Problemas</A>
</H4>
  

<OL>
<LI><A NAME="tex2html1056"
  HREF="http://stackoverflow.com/questions/8957594/sinatra-session-gets-destroyed-automatically">I'm not sure why but my session gets wiped out every request?</A>
</LI>
<LI>To keep sessions consistent you need to set a session secret, e.g.:

<P>
<PRE>
set :session_secret, 'super secret'
</PRE>
When it's not set sinatra generates random one on application start
and shotgun restarts application before every request.
</LI>
</OL>

<P>

<H4><A NAME="SECTION033100060000000000000">
Véanse</A>
</H4>
  

<P>

<OL>
<LI><A NAME="tex2html1057"
  HREF="http://brettu.com/ruby-daily-ruby-tips-60-simple-use-of-sessions-in-sinatra/">Daily Ruby Tips #60 – Simple Use of Sessions in Sinatra
May 6, 2013</A>
</LI>
<LI>La sección <I>Cookies</I> en Rack <A HREF="node397.html#section:cookies">31.8</A>.
</LI>
<LI><A NAME="tex2html1058"
  HREF="http://rubylearning.com/blog/2009/09/30/cookie-based-sessions-in-sinatra/">Cookie-based Sessions in Sinatra
by JULIO JAVIER CICCHELLI on SEPTEMBER 30, 2009</A>
RubyLearning Blog. El código está en
<A NAME="tex2html1059"
  HREF="http://gist.github.com/205962">un Gist en GitHub</A>
</LI>
</OL>

<P>

<P>
<BR><HR>
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><STRONG>Subsecciones</STRONG></A>

<UL CLASS="ChildLinks">
<LI><UL>
<LI><UL>
<LI><A NAME="tex2html11174"
  HREF="node451.html#SECTION033100010000000000000">Introducción</A>
<LI><A NAME="tex2html11175"
  HREF="node451.html#SECTION033100020000000000000">Cookies</A>
<LI><A NAME="tex2html11176"
  HREF="node451.html#SECTION033100030000000000000">Ejemplo con Sesiones</A>
<LI><A NAME="tex2html11177"
  HREF="node451.html#SECTION033100040000000000000">Ejemplo con Cookies</A>
<LI><A NAME="tex2html11178"
  HREF="node451.html#SECTION033100050000000000000">Problemas</A>
<LI><A NAME="tex2html11179"
  HREF="node451.html#SECTION033100060000000000000">Véanse</A>
</UL></UL></UL>
<!--End of Table of Child-Links-->

<DIV CLASS="navigation"><HR>
<!--Navigation Panel-->
<A NAME="tex2html11172"
  HREF="node452.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html11166"
  HREF="node433.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html11160"
  HREF="node450.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html11168"
  HREF="node851.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html11170"
  HREF="node854.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html29"
  HREF="http://tinyurl.com/lpp1415"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="LPP moodle"></A><A NAME="tex2html30"
  HREF="https://campusvirtual.ull.es/1415/course/view.php?id=5678"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="SYTW moodle"></A><A NAME="tex2html31"
  HREF="perlexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="pdf"></A><A NAME="tex2html32"
  HREF="https://dl.dropbox.com/u/14539152/LPP/LPPbook/index.html"><IMG
  WIDTH="60" ALIGN="BOTTOM" BORDER="0"
 SRC="lupa.gif"
 ALT="ruby gems"></A><A NAME="tex2html33"
  HREF="http://www.ruby-doc.org/"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="perlonion.jpeg"
 ALT="perldoc"></A><A NAME="tex2html34"
  HREF="http://www.github.com"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="google-code-project-hosting.jpeg"
 ALT="github"></A><A NAME="tex2html35"
  HREF="http://rubylearning.com/blog/"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="blogs"></A><A NAME="tex2html36"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html37"
  HREF="http://www.ull.es/view/centros/etsii/Inicio/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html38"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html39"
  HREF="https://plus.google.com/u/0/communities/115470806071217401678"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-lpp-1314"></A><A NAME="tex2html40"
  HREF="https://plus.google.com/u/0/communities/109091480492072495700"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-stw-1314"></A>
<BR>
<B> Siguiente:</B> <A NAME="tex2html11173"
  HREF="node452.html">Downloads / Descargas /</A>
<B> Subir:</B> <A NAME="tex2html11167"
  HREF="node433.html">Fundamentos</A>
<B> Anterior:</B> <A NAME="tex2html11161"
  HREF="node450.html">Caching / Caches</A>
 &nbsp; <B>  <A NAME="tex2html11169"
  HREF="node851.html">&#205;ndice General</A></B> 
 &nbsp; <B>  <A NAME="tex2html11171"
  HREF="node854.html">&#205;ndice de Materias</A></B> </DIV>
<!--End of Navigation Panel-->
<ADDRESS>
Casiano Rodriguez León
2014-12-09
</ADDRESS>
</BODY>
</HTML>
