
<H1><A NAME="SECTION021030000000000000000">
EventMachine</A>
</H1>

<P>
<A NAME="tex2html572"
  HREF="http://eventmachine.rubyforge.org/">Event::Machine</A><#11171#><#11171#> is an event-driven I/O and lightweight concurrency library for Ruby. It provides event-driven I/O using the <A NAME="11273"><tex2html_anchor_invisible_mark></A><SPAN  CLASS="textbf">Reactor pattern</SPAN>.

<P>
The reactor is the core of <A NAME="tex2html573"
  HREF="http://eventmachine.rubyforge.org/">Event::Machine</A><#11173#><#11173#>. 
All of EM's processing happens in the reactor. 
Your application will create code that hooks into the reactor, using timers, socket connections or various other means. 
Typically you'll wrap your entire application inside an <tex2html_verb_mark>1251<tex2html_verb_mark> block.

<P>
<PRE><tex2html_verbatim_mark>verbatim1191#</PRE>

<P>
This block won't complete until <tex2html_verb_mark>1252<tex2html_verb_mark> is called. The
reactor will loop infinitely.

<P>

<H4><A NAME="SECTION021030010000000000000">
run y stop_event_loop</A>
</H4>
  <TABLE CELLPADDING=3>
</TABLE>

<PRE><tex2html_verbatim_mark>verbatim1192#</PRE>

<P>
<PRE><tex2html_verbatim_mark>verbatim1193#</PRE>

<P>

<H4><A NAME="SECTION021030020000000000000">
reactor_running?</A>
</H4>
  <TABLE CELLPADDING=3>
</TABLE>

<PRE><tex2html_verbatim_mark>verbatim1194#</PRE>

<P>

<OL>
<LI><tex2html_verb_mark>1253<tex2html_verb_mark>
Tells you whether the EventMachine reactor loop is currently running.

<P>
Useful when writing libraries that want to run event-driven code,
but may be running in programs that are already event-driven. 

<P>
In
such cases, if <tex2html_verb_mark>1254<tex2html_verb_mark> returns <tex2html_verb_mark>1255<tex2html_verb_mark>, 
your code can invoke
<tex2html_verb_mark>1256<tex2html_verb_mark> and run your application code inside the block passed to that
method. If this method returns true, just execute your event-aware
code.

<P>
</LI>
<LI><tex2html_verb_mark>1257<tex2html_verb_mark>

<P>
Schedules a proc for execution immediately after the next ;SPMquot;turn;SPMquot;
through the reactor core. 
</LI>
</OL>

<P>

<H4><A NAME="SECTION021030030000000000000">
add_timer</A>
</H4>
  <TABLE CELLPADDING=3>
</TABLE>

<PRE><tex2html_verbatim_mark>verbatim1195#</PRE>

<P>

<OL>
<LI><tex2html_verb_mark>1258<tex2html_verb_mark>

<P>
Adds a one-shot timer to the event loop. 
Call it with one or two parameters. 
The first parameters is a delay-time expressed in seconds (not milliseconds). 
The second parameter, if present, must be an object that responds to <tex2html_verb_mark>1259<tex2html_verb_mark>. 
If 2nd parameter is not given, then you can also simply pass a block to the method call.

<P>
This method may be called from the block passed to <tex2html_verb_mark>1260<tex2html_verb_mark> or from any
callback method. It schedules execution of the <tex2html_verb_mark>1261<tex2html_verb_mark> or block passed
to it, after the passage of an interval of time equal to at least
the number of seconds specified in the first parameter to the call.

<P>
<tex2html_verb_mark>1262<tex2html_verb_mark> is a non-blocking method. Callbacks can and will
be called during the interval of time that the timer is in effect.
There is no built-in limit to the number of timers that can be
outstanding at any given time.

<P>
</LI>
<LI><tex2html_verb_mark>1263<tex2html_verb_mark>

<P>
Adds a periodic timer to the event loop. It takes the same parameters
as the one-shot timer method, <tex2html_verb_mark>1264<tex2html_verb_mark>. This method schedules
execution of the given block repeatedly, at intervals of time at
least as great as the number of seconds given in the first parameter
to the call.
</LI>
</OL>

<P>

<H4><A NAME="SECTION021030040000000000000">
next_tick</A>
</H4>
  <TABLE CELLPADDING=3>
</TABLE>

<PRE><tex2html_verbatim_mark>verbatim1196#</PRE>
<tex2html_verb_mark>1265<tex2html_verb_mark>
Schedules a proc for execution immediately after the next ;SPMquot;turn;SPMquot; through the reactor core.

<P>
This can be useful for improving memory management and/or application responsiveness, especially when scheduling large amounts of data for writing to a network connection.

<P>
This method takes either a single argument (which must be a callable object) or a block.

<P>
Parameters:
<PRE><tex2html_verbatim_mark>verbatim1197#</PRE>

<P>
<PRE><tex2html_verbatim_mark>verbatim1198#</PRE>

<P>

<H4><A NAME="SECTION021030050000000000000">
defer</A>
</H4>
  <TABLE CELLPADDING=3>
</TABLE>

<tex2html_verb_mark>1266<tex2html_verb_mark> is used to push a otherwise blocking operation on an EM internal queue whose jobs are then processed by a thread pool of 20 threads (by default). 

<P>
You can use <tex2html_verb_mark>1267<tex2html_verb_mark> with operations which arenâ€™t made to work asynchronously.

<P>
<PRE><tex2html_verbatim_mark>verbatim1199#</PRE>
<tex2html_verb_mark>1268<tex2html_verb_mark>

<P>

<OL>
<LI><A NAME="tex2html574"
  HREF="http://eventmachine.rubyforge.org/">Event::Machine</A><#11202#><#11202#>.defer is used for integrating blocking operations
into <A NAME="tex2html575"
  HREF="http://eventmachine.rubyforge.org/">Event::Machine</A><#11203#><#11203#>'s control flow. 

<P>
</LI>
<LI>The action of <A NAME="11301"><tex2html_anchor_invisible_mark></A><SPAN  CLASS="textbf">defer</SPAN> is to take
the block specified in the first parameter (the ;SPMquot;operation;SPMquot;) and
schedule it for asynchronous execution on an internal thread pool
maintained by <A NAME="tex2html576"
  HREF="http://eventmachine.rubyforge.org/">Event::Machine</A><#11205#><#11205#>. 

<P>
</LI>
<LI>When the operation completes, it will
pass the result computed by the block (if any) back to the <A NAME="tex2html577"
  HREF="http://eventmachine.rubyforge.org/">Event::Machine</A><#11206#><#11206#>
reactor. 

<P>
</LI>
<LI>Then, <A NAME="tex2html578"
  HREF="http://eventmachine.rubyforge.org/">Event::Machine</A><#11207#><#11207#> calls the block specified in the second
parameter to defer (the ;SPMquot;callback;SPMquot;), as part of its normal event
handling loop. 

<P>
</LI>
<LI>The result computed by the operation block is passed
as a parameter to the callback. 

<P>
</LI>
<LI>You may omit the callback parameter
if you don't need to execute any code after the operation completes.
</LI>
</OL>

<P>
<PRE><tex2html_verbatim_mark>verbatim1200#</PRE>

<P>

<H4><A NAME="SECTION021030060000000000000">
next_tick versus defer</A>
</H4>
  <TABLE CELLPADDING=3>
</TABLE>


<P>

<OL>
<LI>The loop runs on a single thread. 
</LI>
<LI>What this means is that apart from I/O - at any time, only one task/event is processed by the event loop. 
</LI>
<LI>You can imagine this event loop to be a queue of callbacks that are processed on every tick of the event loop. 
</LI>
<LI>So, even if you are running on a multi-core machine, you will not get any parallelism in terms of actual processing - all events will be processed only one at a time. 
</LI>
<LI>For every I/O bound task, you can simply define a callback that will get added to the event queue. 
</LI>
<LI>The callback will fire when the I/O operation is done, and in the mean time, the application can continue to process other I/O bound requests.
</LI>
<LI>Given this model, what <tex2html_verb_mark>1269<tex2html_verb_mark> 
actually does is defer the execution of an action till the next pass around the event loop.
</LI>
</OL>

<P>
