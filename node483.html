<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<!--Converted with LaTeX2HTML 2008 (1.71)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>Build a Sinatra API Using TDD, Heroku, and Continuous Integration with Travis</TITLE>
<META NAME="description" CONTENT="Build a Sinatra API Using TDD, Heroku, and Continuous Integration with Travis">
<META NAME="keywords" CONTENT="perlexamples">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="Generator" CONTENT="LaTeX2HTML v2008">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="mystyle.css">

<LINK REL="next" HREF="node484.html">
<LINK REL="previous" HREF="node482.html">
<LINK REL="up" HREF="node481.html">
<LINK REL="next" HREF="node484.html">
</HEAD>

<BODY >

<DIV CLASS="navigation"><!--Navigation Panel-->
<A NAME="tex2html11675"
  HREF="node484.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html11669"
  HREF="node481.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html11663"
  HREF="node482.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html11671"
  HREF="node851.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html11673"
  HREF="node854.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html29"
  HREF="http://tinyurl.com/lpp1415"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="LPP moodle"></A><A NAME="tex2html30"
  HREF="https://campusvirtual.ull.es/1415/course/view.php?id=5678"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="SYTW moodle"></A><A NAME="tex2html31"
  HREF="perlexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="pdf"></A><A NAME="tex2html32"
  HREF="https://dl.dropbox.com/u/14539152/LPP/LPPbook/index.html"><IMG
  WIDTH="60" ALIGN="BOTTOM" BORDER="0"
 SRC="lupa.gif"
 ALT="ruby gems"></A><A NAME="tex2html33"
  HREF="http://www.ruby-doc.org/"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="perlonion.jpeg"
 ALT="perldoc"></A><A NAME="tex2html34"
  HREF="http://www.github.com"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="google-code-project-hosting.jpeg"
 ALT="github"></A><A NAME="tex2html35"
  HREF="http://rubylearning.com/blog/"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="blogs"></A><A NAME="tex2html36"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html37"
  HREF="http://www.ull.es/view/centros/etsii/Inicio/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html38"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html39"
  HREF="https://plus.google.com/u/0/communities/115470806071217401678"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-lpp-1314"></A><A NAME="tex2html40"
  HREF="https://plus.google.com/u/0/communities/109091480492072495700"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-stw-1314"></A>
<BR>
<B> Siguiente:</B> <A NAME="tex2html11676"
  HREF="node484.html">Mini MiniTest Tutorial</A>
<B> Subir:</B> <A NAME="tex2html11670"
  HREF="node481.html">Testing en Sinatra</A>
<B> Anterior:</B> <A NAME="tex2html11664"
  HREF="node482.html">Véase</A>
 &nbsp; <B>  <A NAME="tex2html11672"
  HREF="node851.html">&#205;ndice General</A></B> 
 &nbsp; <B>  <A NAME="tex2html11674"
  HREF="node854.html">&#205;ndice de Materias</A></B> 
<BR>
<BR></DIV>
<!--End of Navigation Panel-->
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><STRONG>Subsecciones</STRONG></A>

<UL CLASS="ChildLinks">
<LI><UL>
<LI><A NAME="tex2html11677"
  HREF="node483.html#SECTION03602010000000000000">Donde</A>
<LI><A NAME="tex2html11678"
  HREF="node483.html#SECTION03602020000000000000">The Problem</A>
<LI><A NAME="tex2html11679"
  HREF="node483.html#SECTION03602030000000000000">Monkey-patch the Integer class</A>
<LI><A NAME="tex2html11680"
  HREF="node483.html#SECTION03602040000000000000">See it working</A>
<LI><A NAME="tex2html11681"
  HREF="node483.html#SECTION03602050000000000000">Testing con minitest/autorun y rack/test</A>
<LI><A NAME="tex2html11682"
  HREF="node483.html#SECTION03602060000000000000">Especificando Requisitos</A>
</UL></UL>
<!--End of Table of Child-Links-->
<HR>

<H2><A NAME="SECTION03602000000000000000"></A>
<A NAME="subsection:buildasinatraapiusingtddherokuandci"></A>
<BR>
Build a Sinatra API Using TDD, Heroku, and Continuous Integration with Travis
</H2>

<P>

<H4><A NAME="SECTION03602010000000000000">
Donde</A>
</H4>
  

<P>

<OL>
<LI><A NAME="tex2html1118"
  HREF="http://www.sitepoint.com/build-sinatra-api-using-tdd-heroku-continuous-integration-travis/">Build a Sinatra API Using TDD, Heroku, and Continuous Integration with Travis
by Darren Jones. Published December 9, 2013</A>
SitePoint
</LI>
<LI>Código del artículo anterior
<A NAME="tex2html1119"
  HREF="https://github.com/crguezl/number_cruncher">https://github.com/crguezl/number_cruncher</A>
</LI>
</OL>

<P>

<H4><A NAME="SECTION03602020000000000000">
The Problem</A>
</H4>
  

<P>
The application to build is a Number Cruncher. It will return information about numbers, such as its factors, whether it is odd or even, and if it’s prime.

<P>

<H4><A NAME="SECTION03602030000000000000">
Monkey-patch the Integer class</A>
</H4>
  

The first thing we want to do is monkey-patch the Integer class to add a
method that returns the factors of a number as an array. 

<P>
<PRE>
[~/sinatra/sinatra-number_cruncher(master)]$ cat -n number_cruncher.rb | head -n 10
     1  class Integer
     2    def factors
     3      square_root = self**0.5
     4      (1..square_root).map{ |n| [n,self/n] if self/n*n == self }.compact.flatten.sort
     5    end
     6    
     7    def prime?
     8      self.factors.size == 2 ? true : false
     9    end
    10  end
</PRE>

<P>
I also want to
add a <code>prime?</code> method to test if a number is prime. 

<P>
Once I’ve done this,
I’ll use Sinatra to provide an API that will return information about
a number in JSON format.

<P>

<H4><A NAME="SECTION03602040000000000000">
See it working</A>
</H4>
  

<P>

<UL>
<LI>Number Cruncher is deployed now (September 2014) in
Heroku at
<A NAME="tex2html1120"
  HREF="http://primefactorization.herokuapp.com/9">http://primefactorization.herokuapp.com/#number</A>.
</LI>
<LI>You can see the 
<A NAME="tex2html1121"
  HREF="https://travis-ci.org/crguezl/number_cruncher">Continuous Integration tests running on Travis</A>
</LI>
<LI><A NAME="tex2html1122"
  HREF="https://github.com/crguezl/number_cruncher">The code is on GitHub</A>
</LI>
</UL>

<P>

<H4><A NAME="SECTION03602050000000000000">
Testing con minitest/autorun y rack/test</A>
</H4>
  

<P>
Before we write any code, we should write some tests that
cover the description above. First of all, create a file called
<code>number_cruncher.rb</code> and another called <code>test.rb</code>. 

<P>
Then add the
following 
<A NAME="tex2html1123"
  HREF="http://docs.seattlerb.org/minitest/">MiniTest </A>
setup code to <code>test.rb</code>:

<P>
<PRE>
ENV['RACK_ENV'] = 'test'
require 'minitest/autorun'
require 'rack/test'
require_relative 'number_cruncher.rb'
 
include Rack::Test::Methods
 
def app
  Sinatra::Application
end
</PRE>

<P>
The 
<A NAME="tex2html1124"
  HREF="http://rdoc.info/github/brynary/rack-test/master/Rack/Test/Methods">Rack::Test::Methods </A>
module includes a variety of helper methods for
simulating requests against an application and asserting expectations
about the response. It’s typically included directly within the test
context and makes a few helper methods and attributes available.

<P>
This module serves as the primary integration point for using 
<A NAME="tex2html1125"
  HREF="http://rdoc.info/github/brynary/rack-test/">Rack::Test</A>
in a testing environment. 

<P>
It depends on an <code>app</code> method being defined
in the same context, and provides the 
Rack::Test API methods 
(see
<A NAME="tex2html1126"
  HREF="http://rdoc.info/github/brynary/rack-test/Rack/Test/Session">Rack::Test::Session </A>
for their documentation).

<P>
If you want to test one Sinatra 
<code>app</code> in isolation, you just return <code>Sinatra::Application</code> 
as shown above.

<P>
If you are using Sinatra in the modular style, 
(Véase la sección <A HREF="node480.html#chapter:aplicacionesmodularessinatra">35</A>)
replace 
<code>Sinatra::Application</code> 
above with the 
<FONT COLOR="#0000ff"> class name</FONT> of your <code>app</code>.

<P>

<H4><A NAME="SECTION03602060000000000000">
Especificando Requisitos</A>
</H4>
  

<P>
Now, we’ll write a spec to test some of the features described
above. Add the following code to the bottom of <code>test.rb</code>:
<PRE>
describe "Number Cruncher" do
 
  it "should return the factors of 6" do
    6.factors.must_equal [1,2,3,6]
  end
 
  it "should say that 2 is prime" do
    assert 2.prime?
  end
 
  it "should say that 10 is not prime" do
    refute 10.prime?
  end
 
  it "should return json" do
    get '/6'
    last_response.headers['Content-Type'].must_match 'application/json'
  end 
 
  it "should return the correct info about 6 as json" do
    get '/6'
    six_info = { number: 6, factors: 6.factors, 
                 odd: 6.odd?, 
                 even: 6.even?, prime: 6.prime? }
    six_info.to_json.must_equal last_response.body
  end
 
end
</PRE>

<P>
The first test is for the factors method that I plan to add to the
Integer class. We check to see that if the integer 6 calls the factors
method followed by if the factors of 6 are returned as an array.

<P>
Next, test the <code>prime?</code> method that will also be added to the Integer
class. First of all, check to see if 2 returns true and then if 10
returns false.

<P>
The last two tests are specific to the API. 
The fourth test checks to see
if the app is returning JSON. 
This is done by performing a get request
with <code>6</code> as a parameter. 

<P>
The <code>last_response.headers</code> are checked for a
content-type of <code>application/json;charset=utf-8</code>. 

<P>
In the last test,
we check that the correct info is returned by comparing a JSON string
to the <code>last_response.body</code> method.

<P>
To run our tests, enter the following in a terminal prompt:

<P>
<PRE>
$ ruby test.rb
This produces the following output:
# Running:
EEEEE
Finished in 0.008729s, 572.8333 runs/s, 0.0000 assertions/s. 
5 runs, 0 assertions, 0 failures, 5 errors, 0 skips
</PRE>
All five of our tests produce errors, which is expected since we haven’t
written any code yet. Let’s see if we can get those tests passing.

<P>

<DIV CLASS="navigation"><HR>
<!--Navigation Panel-->
<A NAME="tex2html11675"
  HREF="node484.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html11669"
  HREF="node481.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html11663"
  HREF="node482.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html11671"
  HREF="node851.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html11673"
  HREF="node854.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html29"
  HREF="http://tinyurl.com/lpp1415"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="LPP moodle"></A><A NAME="tex2html30"
  HREF="https://campusvirtual.ull.es/1415/course/view.php?id=5678"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="SYTW moodle"></A><A NAME="tex2html31"
  HREF="perlexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="pdf"></A><A NAME="tex2html32"
  HREF="https://dl.dropbox.com/u/14539152/LPP/LPPbook/index.html"><IMG
  WIDTH="60" ALIGN="BOTTOM" BORDER="0"
 SRC="lupa.gif"
 ALT="ruby gems"></A><A NAME="tex2html33"
  HREF="http://www.ruby-doc.org/"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="perlonion.jpeg"
 ALT="perldoc"></A><A NAME="tex2html34"
  HREF="http://www.github.com"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="google-code-project-hosting.jpeg"
 ALT="github"></A><A NAME="tex2html35"
  HREF="http://rubylearning.com/blog/"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="blogs"></A><A NAME="tex2html36"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html37"
  HREF="http://www.ull.es/view/centros/etsii/Inicio/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html38"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html39"
  HREF="https://plus.google.com/u/0/communities/115470806071217401678"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-lpp-1314"></A><A NAME="tex2html40"
  HREF="https://plus.google.com/u/0/communities/109091480492072495700"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-stw-1314"></A>
<BR>
<B> Siguiente:</B> <A NAME="tex2html11676"
  HREF="node484.html">Mini MiniTest Tutorial</A>
<B> Subir:</B> <A NAME="tex2html11670"
  HREF="node481.html">Testing en Sinatra</A>
<B> Anterior:</B> <A NAME="tex2html11664"
  HREF="node482.html">Véase</A>
 &nbsp; <B>  <A NAME="tex2html11672"
  HREF="node851.html">&#205;ndice General</A></B> 
 &nbsp; <B>  <A NAME="tex2html11674"
  HREF="node854.html">&#205;ndice de Materias</A></B> </DIV>
<!--End of Navigation Panel-->
<ADDRESS>
Casiano Rodriguez León
2014-12-09
</ADDRESS>
</BODY>
</HTML>
