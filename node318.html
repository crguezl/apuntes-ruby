<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<!--Converted with LaTeX2HTML 2008 (1.71)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>Testing con Rack::Test y Cucumber</TITLE>
<META NAME="description" CONTENT="Testing con Rack::Test y Cucumber">
<META NAME="keywords" CONTENT="perlexamples">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="Generator" CONTENT="LaTeX2HTML v2008">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="mystyle.css">

<LINK REL="previous" HREF="node317.html">
<LINK REL="up" HREF="node316.html">
<LINK REL="next" HREF="node319.html">
</HEAD>

<BODY >

<DIV CLASS="navigation"><!--Navigation Panel-->
<A NAME="tex2html8619"
  HREF="node319.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html8613"
  HREF="node316.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html8609"
  HREF="node317.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html8615"
  HREF="node851.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html8617"
  HREF="node854.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html29"
  HREF="http://tinyurl.com/lpp1415"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="LPP moodle"></A><A NAME="tex2html30"
  HREF="https://campusvirtual.ull.es/1415/course/view.php?id=5678"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="SYTW moodle"></A><A NAME="tex2html31"
  HREF="perlexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="pdf"></A><A NAME="tex2html32"
  HREF="https://dl.dropbox.com/u/14539152/LPP/LPPbook/index.html"><IMG
  WIDTH="60" ALIGN="BOTTOM" BORDER="0"
 SRC="lupa.gif"
 ALT="ruby gems"></A><A NAME="tex2html33"
  HREF="http://www.ruby-doc.org/"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="perlonion.jpeg"
 ALT="perldoc"></A><A NAME="tex2html34"
  HREF="http://www.github.com"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="google-code-project-hosting.jpeg"
 ALT="github"></A><A NAME="tex2html35"
  HREF="http://rubylearning.com/blog/"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="blogs"></A><A NAME="tex2html36"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html37"
  HREF="http://www.ull.es/view/centros/etsii/Inicio/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html38"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html39"
  HREF="https://plus.google.com/u/0/communities/115470806071217401678"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-lpp-1314"></A><A NAME="tex2html40"
  HREF="https://plus.google.com/u/0/communities/109091480492072495700"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-stw-1314"></A>
<BR>
<B> Siguiente:</B> <A NAME="tex2html8620"
  HREF="node319.html">La API de Capybara</A>
<B> Subir:</B> <A NAME="tex2html8614"
  HREF="node316.html">Capybara y Rack::Test</A>
<B> Anterior:</B> <A NAME="tex2html8610"
  HREF="node317.html">Testeando una Aplicación Sinatra</A>
 &nbsp; <B>  <A NAME="tex2html8616"
  HREF="node851.html">&#205;ndice General</A></B> 
 &nbsp; <B>  <A NAME="tex2html8618"
  HREF="node854.html">&#205;ndice de Materias</A></B> 
<BR>
<BR></DIV>
<!--End of Navigation Panel-->
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><STRONG>Subsecciones</STRONG></A>

<UL CLASS="ChildLinks">
<LI><UL>
<LI><A NAME="tex2html8621"
  HREF="node318.html#SECTION021142010000000000000">Rakefile</A>
<LI><A NAME="tex2html8622"
  HREF="node318.html#SECTION021142020000000000000">Ejecución de las Pruebas</A>
<LI><A NAME="tex2html8623"
  HREF="node318.html#SECTION021142030000000000000">Desventajas de usar Rack::Test</A>
</UL></UL>
<!--End of Table of Child-Links-->
<HR>

<H2><A NAME="SECTION021142000000000000000">
Testing con Rack::Test y Cucumber</A>
</H2>
Desde la perspectiva de Capybara, la interacción con nuestra aplicación Sinatra
es la misma que la interacción con una aplicación remota.

<P>
La única diferencia esta en el setup.

<P>
Vamos a usar Cucumber.  

<P>
Cucumber es una herramienta para escribir <A NAME="13744"></A><SPAN  CLASS="textbf">acceptance tests</SPAN>.
En la metodología TDD el 
<A NAME="tex2html661"
  HREF="http://es.wikipedia.org/wiki/Stakeholder">stackholder/parte interesada en el negocio</A>
en vez de pasarle los requisitos al equipo de desarrollo, colabora con los desarrolladores en la escritura de las pruebas
que expresan el resultado que el quiere.

<P>
Es por eso que a este tipo de pruebas se las denominan <A NAME="13746"></A><SPAN  CLASS="textbf">acceptance tests</SPAN>:
intentan capturar lo que el stackholder quiere.

<P>
Estas pruebas son diferentes de los tests unitarios cuyo motivo es ayudar 
a los desarrolladores a comprobar su diseño software.

<P>
Se suele decir que 
<FONT COLOR="#0000ff"> los tests unitarios nos aseguran que construimos
la cosa correctamente mientras que los tests de aceptación nos aseguran 
que construimos la cosa correcta</FONT>.

<P>
Cuando se usa Behaviour-Driven Development BDD  nos preocupamos
de escribir los acceptance tests  como <A NAME="13750"></A><SPAN  CLASS="textbf">ejemplos</SPAN>/<A NAME="13752"></A><SPAN  CLASS="textbf">examples</SPAN>
que cualquiera pueda leer y entender.

<P>
Esto es lo que Cucumber intenta: hacer que la colaboración entre stackholders
y desarrolladores sean fluída.

<P>
Este es un ejemplo de test de aceptación Cucumber:

<P>
<PRE>
Feature: Filling a Book Review

  Scenario: Complete Book Review
    Given I am on a book review site
    When I submit a book review
    Then I should see the saved details confirmed
</PRE>

<P>
Nótese como las pruebas son especificadas como <A NAME="13754"></A><SPAN  CLASS="textbf">examples</SPAN>/ejemplos
de como se debe conducir el sistema en un escenario concreto.

<P>

<UL>
<LI>Cucumber es una herramienta para usar en la línea de comandos.
</LI>
<LI>Cuando la ejecutamos lee nuestras especificaciones en ficheros denominados
<A NAME="13756"></A><SPAN  CLASS="textbf">features</SPAN>, 
las examina para encontrar los <A NAME="13758"></A><SPAN  CLASS="textbf">escenarios</SPAN> a probar y
corre los escenarios que son una lista de pasos/<A NAME="13760"></A><SPAN  CLASS="textbf">steps</SPAN> que Cucumber
debe trabajar. 
</LI>
</UL>

<P>
Los ficheros de features están escritos en un lenguaje que se
denomina Gherkin (pepinillo).

<P>
Cuando se usa cucumber lo primero es crear un fichero <code>features</code>
en el que se guardan las pruebas.

<P>
Esta es la estructura de <code>features/chapter3/</code>:
<PRE>
[~/application_testing_with_capybara(master)]$ tree features/chapter3/
features/chapter3/
|-- sinatra.feature
`-- steps
    `-- sinatra.rb

1 directory, 2 files
</PRE>

<P>
Cada prueba Cucumber se denomina <A NAME="13762"></A><SPAN  CLASS="textbf">scenario</SPAN> y cada scenario
contiene <A NAME="13764"></A><SPAN  CLASS="textbf">steps</SPAN> que le dicen a Cucumber que hay que hacer.

<P>
Este es el fichero <code>sinatra.feature</code>:
<PRE>
[~/application_testing_with_capybara(master)]$ cat features/chapter3/sinatra.feature 
Feature: Using Capybara and Rack-Test to Interact with Sinatra App

  Scenario: Complete Book Review
    Given I am on a book review site
    When I submit a book review
    Then I should see the saved details confirmed
</PRE>

<P>
Las palabras clave 
 <TT>Feature</TT> ,  <TT>Scenario</TT> ,  <TT>Given</TT> ,  <TT>When</TT>  y  <TT>Then</TT> 
son reservadas. El resto es texto. La sintáxis se denomina <A NAME="13771"></A><SPAN  CLASS="textbf">Gherkin</SPAN>.
Un fichero Gherkin suele tener una estructura como esta:

<P>
<PRE>
 1: Feature: Some terse yet descriptive text of what is desired
 2:   Textual description of the business value of this feature
 3:   Business rules that govern the scope of the feature
 4:   Any additional information that will make the feature easier to understand
 5: 
 6:   Scenario: Some determinable business situation
 7:     Given some precondition
 8:       And some other precondition
 9:      When some action by the actor
10:       And some other action
11:       And yet another action
12:      Then some testable outcome is achieved
13:       And something else we can check happens too
14: 
15:   Scenario: A different situation
16:       ...
</PRE>

<P>
Es necesario implantar el significado de estos pasos.
En nuestro caso los ponemos en <code>features/chapter3/steps/sinatra.rb</code>.
Cucumber nos permite ponerle en cualquier subdirectorio 
siempre que la extensión sea <code>.rb</code>.

<P>
Estos son los contenidos de <code>steps/sinatra.rb</code>:
<PRE>
[~/application_testing_with_capybara(master)]$ cat features/chapter3/steps/sinatra.rb 
Given(/^I am on a book review site$/) do
  visit('/form')
end

When(/^I submit a book review$/) do
  fill_in 'name', :with =&gt; 'Matt'
  fill_in 'title', :with =&gt; 'Catch 22'
  fill_in 'review', :with =&gt; 'Alright I guess....'
  select '20 - 50', :from =&gt; 'age'
  click_on 'Submit'
end

Then(/^I should see the saved details confirmed$/) do
  page.should have_text 'You submitted the following on:'
  expect(find('#name')).to have_text 'Matt'
  expect(find('#age')).to have_text '20-50'
  expect(find('#review')).to have_text 'Alright I guess....'
  expect(find('#title')).to have_text 'Catch 22'
end
</PRE>

<P>
Cucumber falla un step si su definición genera una excepción (<code>raise</code>).

<P>
Junto con las features le damos a Cucumber un conjunto de 
<FONT COLOR="#0000ff"> step definitions</FONT>
como el anterior. 

<P>
En este fichero establecemos una correspondencia entre el lenguaje orientado al
cliente y el código Ruby que debe llevar a cabo las acciones.

<P>
Es aquí donde interviene Capybara que nos provee 
de un DSL para la automatización del navegador.

<P>
Esta jerarquía, desde las features hasta las librerías de 
automatización como Capybara pueden ilustrarse así:
<br/>
<br/>
<img src="cucumberstack.png" width="70%" />


<P>
El fichero <code>support/env.rb</code> gobierna la configuración:

<P>
<PRE>
[~/application_testing_with_capybara(rack_version)]$ cat features/support/env.rb
require 'bundler'
Bundler.require
require 'capybara/cucumber'
require 'rspec/expectations'
require_relative '../../sinatra/app'

Capybara.default_driver = :rack_test 

Capybara.app = BookReview #our Sinatra app
</PRE>

<UL>
<LI>En este fichero establecemos el valor de <code>Capybara.app</code>
a la clase de nuestra aplicación Sinatra (<code>BookReview</code>).

<P>
En el caso de una aplicación sinatra clásica pondríamos:
<PRE>
Capybara.app = Sinatra::Application
</PRE>

<P>
</LI>
<LI>También establecemos <code>Capybara.default_driver</code> a <code>:rack_test</code>
de manera que se use <code>Rack::Test</code> en vez de Selenium. De este modo 
la ejecución será mucho mas rápida.
</LI>
<LI>Ademas indicamos que queremos trabajar con <code>capybara</code>, con <code>rspec</code>
y cargamos nuestra aplicación para que pueda ser testeada:
<PRE>
require 'capybara/cucumber'
require 'rspec/expectations'
require_relative '../../sinatra/app'
</PRE>
</LI>
<LI>La línea <code>Bundler.require</code>:
<PRE>
require 'bundler'
Bundler.require
</PRE>
itera sobre cada gema en el <code>Gemfile</code> y hace un <code>require</code>
de todas las gemas que no hayan sido explícitamente 
desabilitadas con
la opción <code>:require =&gt; false</code>. 

<P>
Es posible pasarle 
una lista de grupos:
<PRE>
Bundler.require(:default, :development)
</PRE>
</LI>
</UL>

<P>

<H4><A NAME="SECTION021142010000000000000">
Rakefile</A>
</H4>
  

<P>
<PRE>
[~/application_testing_with_capybara(master)]$ cat Rakefile 
task :default =&gt; :rackfeatures
task :rackfeatures do
  sh "cucumber -r features features/chapter3/sinatra.feature "
end
</PRE>

<P>

<H4><A NAME="SECTION021142020000000000000">
Ejecución de las Pruebas</A>
</H4>
  

<P>
<PRE>
[~/application_testing_with_capybara(master)]$ rake
cucumber -r features features/chapter3/sinatra.feature 
Feature: Using Capybara and Rack-Test to Interact with Sinatra App

  Scenario: Complete Book Review                  # features/chapter3/sinatra.feature:3
    Given I am on a book review site              # features/chapter3/steps/sinatra.rb:1
    When I submit a book review                   # features/chapter3/steps/sinatra.rb:5
    Then I should see the saved details confirmed # features/chapter3/steps/sinatra.rb:13

1 scenario (1 passed)
3 steps (3 passed)
0m0.070s
</PRE>

<P>

<H4><A NAME="SECTION021142030000000000000">
Desventajas de usar Rack::Test</A>
</H4>
  

<P>
Hay al menos dos desventajas 

<P>

<UL>
<LI>Rack::Test no es un navegador 
</LI>
<LI>Rack::Test no permite ejecutar código en el lado del cliente
</LI>
</UL>

<P>

<DIV CLASS="navigation"><HR>
<!--Navigation Panel-->
<A NAME="tex2html8619"
  HREF="node319.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html8613"
  HREF="node316.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html8609"
  HREF="node317.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html8615"
  HREF="node851.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html8617"
  HREF="node854.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html29"
  HREF="http://tinyurl.com/lpp1415"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="LPP moodle"></A><A NAME="tex2html30"
  HREF="https://campusvirtual.ull.es/1415/course/view.php?id=5678"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="SYTW moodle"></A><A NAME="tex2html31"
  HREF="perlexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="pdf"></A><A NAME="tex2html32"
  HREF="https://dl.dropbox.com/u/14539152/LPP/LPPbook/index.html"><IMG
  WIDTH="60" ALIGN="BOTTOM" BORDER="0"
 SRC="lupa.gif"
 ALT="ruby gems"></A><A NAME="tex2html33"
  HREF="http://www.ruby-doc.org/"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="perlonion.jpeg"
 ALT="perldoc"></A><A NAME="tex2html34"
  HREF="http://www.github.com"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="google-code-project-hosting.jpeg"
 ALT="github"></A><A NAME="tex2html35"
  HREF="http://rubylearning.com/blog/"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="blogs"></A><A NAME="tex2html36"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html37"
  HREF="http://www.ull.es/view/centros/etsii/Inicio/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html38"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html39"
  HREF="https://plus.google.com/u/0/communities/115470806071217401678"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-lpp-1314"></A><A NAME="tex2html40"
  HREF="https://plus.google.com/u/0/communities/109091480492072495700"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="ull-etsii-grado-stw-1314"></A>
<BR>
<B> Siguiente:</B> <A NAME="tex2html8620"
  HREF="node319.html">La API de Capybara</A>
<B> Subir:</B> <A NAME="tex2html8614"
  HREF="node316.html">Capybara y Rack::Test</A>
<B> Anterior:</B> <A NAME="tex2html8610"
  HREF="node317.html">Testeando una Aplicación Sinatra</A>
 &nbsp; <B>  <A NAME="tex2html8616"
  HREF="node851.html">&#205;ndice General</A></B> 
 &nbsp; <B>  <A NAME="tex2html8618"
  HREF="node854.html">&#205;ndice de Materias</A></B> </DIV>
<!--End of Navigation Panel-->
<ADDRESS>
Casiano Rodriguez León
2014-12-11
</ADDRESS>
</BODY>
</HTML>
